"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}var VERSION="0.9.2",ACTIVATE_DEBUG=!1,DEFAULT_XML="https://adrianotiger.github.io/desktopPet/Pets/esheep64/animations.xml",COLLISION_WITH=["div","hr"],eSheep=function(){function eSheep(e,t){_classCallCheck(this,eSheep),this.userOptions=e||{allowPets:"none",allowPopup:"yes"},this.userOptions.allowPopup||(this.userOptions.allowPopup="yes"),this.userOptions.allowPets||(this.userOptions.allowPets="none"),this.animationFile=DEFAULT_XML,this.id=Date.now()+Math.random(),this.DOMdiv=document.createElement("div"),this.DOMdiv.setAttribute("id",this.id),this.DOMimg=document.createElement("img"),this.DOMinfo=document.createElement("div"),this.parser=new DOMParser,this.xmlDoc=null,this.prepareToDie=!1,this.isChild=null!=t,this.tilesX=1,this.tilesY=1,this.imageW=1,this.imageH=1,this.imageX=1,this.imageY=1,this.flipped=!1,this.dragging=!1,this.infobox=!1,this.animationId=0,this.animationStep=0,this.animationNode=null,this.sprite=new Image,this.HTMLelement=null,this.randS=100*Math.random(),this.screenW=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,this.screenH=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}return _createClass(eSheep,[{key:"Start",value:function(a){void 0!==a&&null!=a&&(this.animationFile=a);var b=new XMLHttpRequest,c=this;b.open("GET",this.animationFile,!0),b.addEventListener("readystatechange",function(){4==this.readyState&&(200==this.status?c._parseXML(this.responseText):console.error("XML not available:"+this.statusText+"\n"+this.responseText))}),b.send(null)}},{key:"remove",value:function(){var a=this;this.prepareToDie=!0,this.DOMinfo.Hide(),setTimeout(function(){a.DOMdiv=a.DOMimg=a.DOMinfo=null,document.getElementById(a.id).outerHTML=""},500)}},{key:"_parseXML",value:function(f){var h=this;this.xmlDoc=this.parser.parseFromString(f,"text/xml");var d=this.xmlDoc.getElementsByTagName("image")[0];this.tilesX=d.getElementsByTagName("tilesx")[0].textContent,this.tilesY=d.getElementsByTagName("tilesy")[0].textContent,this.sprite.addEventListener("load",function(){ACTIVATE_DEBUG&&console.log("Sprite image loaded");var a="width:"+h.sprite.width+"px;height:"+h.sprite.height+"px;position:absolute;top:0px;left:0px;max-width: none;";h.DOMimg.setAttribute("style",a),h.DOMimg.addEventListener("dragstart",function(a){return a.preventDefault(),!1}),h.imageW=h.sprite.width/h.tilesX,h.imageH=h.sprite.height/h.tilesY,a="width:"+h.imageW+"px;height:"+h.imageH+"px;position:fixed;top:"+h.imageY+"px;left:"+h.imageX+"px;transform:rotatey(0deg);cursor:move;z-index:2000;overflow:hidden;image-rendering: crisp-edges;",h.DOMdiv.setAttribute("style",a),h.DOMdiv.appendChild(h.DOMimg),h.isChild?h._spawnChild():h._spawnESheep()}),this.sprite.src="data:image/png;base64,"+d.getElementsByTagName("png")[0].textContent,this.DOMimg.setAttribute("src",this.sprite.src),this.DOMdiv.addEventListener("mousemove",function(c){if(!h.dragging&&1==c.buttons&&0==c.button){h.dragging=!0,h.HTMLelement=null;for(var b=h.xmlDoc.getElementsByTagName("animations")[0].getElementsByTagName("animation"),a=0;a<b.length;a++)if("drag"==b[a].getElementsByTagName("name")[0].textContent){h.animationId=b[a].getAttribute("id"),h.animationStep=0,h.animationNode=b[a];break}}}),document.body.addEventListener("mousemove",function(a){h.dragging&&(h.imageX=parseInt(a.clientX)-h.imageW/2,h.imageY=parseInt(a.clientY)-h.imageH/2,h.DOMdiv.style.left=h.imageX+"px",h.DOMdiv.style.top=h.imageY+"px",h.DOMinfo.style.left=parseInt(h.imageX+h.imageW/2)+"px",h.DOMinfo.style.top=h.imageY+"px")}),document.body.addEventListener("resize",function(){h.screenW=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,h.screenH=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,h.imageY+h.imageH>h.screenH&&(h.imageY=h.screenH-h.imageH,h.DOMdiv.style.top=h.imageY+"px"),h.imageX+h.imageW>h.screenW&&(h.imageX=h.screenW-h.imageW,h.DOMdiv.style.left=h.imageX+"px")}),this.DOMdiv.addEventListener("contextmenu",function(a){return a.preventDefault(),!1}),this.DOMdiv.addEventListener("mouseup",function(a){h.dragging?h.dragging=!1:h.infobox?(h.DOMinfo.Hide(),h.infobox=!1):"yes"===h.userOptions.allowPopup&&(h.DOMinfo.style.left=Math.min(h.screenW-h.imageW,Math.max(h.imageW,parseInt(h.imageX+h.imageW/2)))+"px",h.DOMinfo.style.top=parseInt(h.imageY)+"px",h.DOMinfo.Show(),h.infobox=!0)}),this.DOMinfo.addEventListener("mouseup",function(a){h.DOMinfo.Hide(),h.infobox=!1}),this.DOMinfo.setAttribute("style","width:200px;height:100px;transform:translate(-50%, -50%) scale(0.1);position:fixed;top:100px;left:10px;display:none;border-width:2px;border-radius:5px;border-style:ridge;border-color:#0000ab;text-align:center;text-shadow: 1px 1px 3px #ffff88;box-shadow: 3px 3px 10px #888888;color:black;opacity:0.9;z-index:9999;overflow:auto;transition:transform 0.3s ease;background: linear-gradient(to bottom right, rgba(128,128,255,0.7), rgba(200,200,255,0.4));");var c=this.xmlDoc.getElementsByTagName("header")[0],g=document.createElement("b").appendChild(document.createTextNode(c.getElementsByTagName("title")[0].textContent)),b=document.createElement("sup"),a=document.createElement("a"),e=document.createElement("p");b.appendChild(document.createTextNode("App v."+VERSION)),b.appendChild(document.createElement("br")),b.appendChild(document.createTextNode("Pet v."+c.getElementsByTagName("version")[0].textContent)),b.setAttribute("style","float:right;text-align:right;"),a.appendChild(document.createTextNode("\u{1F3E0}")),a.setAttribute("href","https://github.com/Adrianotiger/web-esheep"),a.setAttribute("target","_blank"),a.setAttribute("style","float:left"),e.appendChild(document.createTextNode(c.getElementsByTagName("info")[0].textContent)),e.setAttribute("style","font-size:"+(100-parseInt(c.getElementsByTagName("info")[0].textContent.length/10))+"%;"),this.DOMinfo.appendChild(b),this.DOMinfo.appendChild(a),"none"!==this.userOptions.allowPets&&((a=document.createElement("a")).appendChild(document.createTextNode("\u2699")),a.setAttribute("href","javascript:;"),a.setAttribute("style","float:left"),this.DOMinfo.appendChild(a),setTimeout(function(){h._loadPetList(a)},100)),this.DOMinfo.appendChild(g),this.DOMinfo.appendChild(document.createElement("br")),this.DOMinfo.appendChild(document.createElement("hr")),this.DOMinfo.appendChild(e),document.body.appendChild(this.DOMinfo),document.body.appendChild(this.DOMdiv),this.DOMinfo.Show=function(){h.DOMinfo.style.display="block",h.DOMinfo.style.transform="translate(-50%, -100%) scale(1.0)"},this.DOMinfo.Hide=function(){h.DOMinfo.style.transform="translate(-50%, -50%) scale(0.1)",setTimeout(function(){h.DOMinfo.style.display="none"},300)}}},{key:"_setPosition",value:function(a,b,c){this.DOMdiv&&(c?(this.imageX=parseInt(a),this.imageY=parseInt(b)):(this.imageX=parseInt(this.imageX)+parseInt(a),this.imageY=parseInt(this.imageY)+parseInt(b)),this.DOMdiv.style.left=this.imageX+"px",this.DOMdiv.style.top=this.imageY+"px")}},{key:"_spawnESheep",value:function(){for(var c=this.xmlDoc.getElementsByTagName("spawns")[0].getElementsByTagName("spawn"),e=0,a=0;a<c.length;a++)e+=parseInt(c[0].getAttribute("probability"));var h=Math.random()*e;for(e=0,a=0;a<c.length;a++)if((e+=parseInt(c[a].getAttribute("probability")))>=h||a==c.length-1){this._setPosition(this._parseKeyWords(c[a].getElementsByTagName("x")[0].textContent),this._parseKeyWords(c[a].getElementsByTagName("y")[0].textContent),!0),ACTIVATE_DEBUG&&console.log("Spawn: "+this.imageX+", "+this.imageY),this.animationId=c[a].getElementsByTagName("next")[0].textContent,this.animationStep=0;for(var b=this.xmlDoc.getElementsByTagName("animations")[0].getElementsByTagName("animation"),f=0;f<b.length;f++)if(b[f].getAttribute("id")==this.animationId){this.animationNode=b[f],b=this.xmlDoc.getElementsByTagName("childs")[0].getElementsByTagName("child");for(var d=0;d<b.length;d++)if(b[d].getAttribute("animationid")==this.animationId){ACTIVATE_DEBUG&&console.log("Child from Spawn");var g=new eSheep(null,!0);g.animationId=b[d].getElementsByTagName("next")[0].textContent;var i=b[d].getElementsByTagName("x")[0].textContent,j=b[d].getElementsByTagName("y")[0].textContent;g._setPosition(this._parseKeyWords(i),this._parseKeyWords(j),!0),g.Start(this.animationFile);break}break}break}this._nextESheepStep()}},{key:"_spawnChild",value:function(){for(var b=this.xmlDoc.getElementsByTagName("animations")[0].getElementsByTagName("animation"),a=0;a<b.length;a++)if(b[a].getAttribute("id")==this.animationId){this.animationNode=b[a];break}this._nextESheepStep()}},{key:"_parseKeyWords",value:function _parseKeyWords(value){value=(value=(value=(value=(value=(value=(value=(value=(value=(value=value.replace(/screenW/g,this.screenW)).replace(/screenH/g,this.screenH)).replace(/areaW/g,this.screenH)).replace(/areaH/g,this.screenH)).replace(/imageW/g,this.imageW)).replace(/imageH/g,this.imageH)).replace(/random/g,100*Math.random())).replace(/randS/g,this.randS)).replace(/imageX/g,this.imageX)).replace(/imageY/g,this.imageY);var ret=0;try{ret=eval(value)}catch(e){console.error("Unable to parse this position: \n'"+value+"'\n Error message: \n"+e.message)}return ret}},{key:"_getNextRandomNode",value:function(h){var c=h.getElementsByTagName("next"),b=this.xmlDoc.getElementsByTagName("animations")[0].getElementsByTagName("animation"),d=0,e=!1;if(0==c.length)return this.isChild?(ACTIVATE_DEBUG&&console.log("Remove child"),document.body.removeChild(this.DOMinfo),document.body.removeChild(this.DOMdiv)):this._spawnESheep(),!1;for(var a=0;a<c.length;a++)d+=parseInt(c[a].getAttribute("probability"));var i=Math.random()*d,g=0;for(d=0,a=0;a<c.length;a++)if((d+=parseInt(c[a].getAttribute("probability")))>=i){g=a;break}for(a=0;a<b.length;a++)if(b[a].getAttribute("id")==c[g].textContent){this.animationId=b[a].getAttribute("id"),this.animationStep=0,this.animationNode=b[a],e=!0;break}if(e){for(a=0,b=this.xmlDoc.getElementsByTagName("childs")[0].getElementsByTagName("child");a<b.length;a++)if(b[a].getAttribute("animationid")==this.animationId){ACTIVATE_DEBUG&&console.log("Child from Animation");var f=new eSheep(null,!0);f.animationId=b[a].getElementsByTagName("next")[0].textContent;var j=b[a].getElementsByTagName("x")[0].textContent,k=b[a].getElementsByTagName("y")[0].textContent;f._setPosition(this._parseKeyWords(j),this._parseKeyWords(k),!0),f.Start(this.animationFile);break}}return e}},{key:"_checkOverlapping",value:function(){var b,e=this.imageX,f=this.imageY+this.imageH,g=20;for(var h in this.HTMLelement&&(g=5),COLLISION_WITH)for(var c=document.body.getElementsByTagName(COLLISION_WITH[h]),a=0;a<c.length;a++)if(f>(b=c[a].getBoundingClientRect()).top-2&&f<b.top+g&&e>b.left&&e<b.right-this.imageW){var d=window.getComputedStyle(c[a]);if(""!=d.borderTopStyle&&"none"!=d.borderTopStyle&&"none"!=d.display)return c[a]}return!1}},{key:"_getNodeValue",value:function(a,b,c){if(this.animationNode&&this.animationNode.getElementsByTagName(a)){if(this.animationNode.getElementsByTagName(a)[0].getElementsByTagName(b)[0]){var d=this.animationNode.getElementsByTagName(a)[0].getElementsByTagName(b)[0].textContent;return this._parseKeyWords(d)}return c}}},{key:"_nextESheepStep",value:function(){if(!this.prepareToDie){var j,c=this._getNodeValue("start","x",0),f=this._getNodeValue("start","y",0),k=(this._getNodeValue("start","offsety",0),this._getNodeValue("start","opacity",1),this._getNodeValue("start","interval",1e3)),b=this._getNodeValue("end","x",0),d=this._getNodeValue("end","y",0),l=(this._getNodeValue("end","offsety",0),this._getNodeValue("end","interval",1),this._getNodeValue("end","interval",1e3)),m=this._parseKeyWords(this.animationNode.getElementsByTagName("sequence")[0].getAttribute("repeat")),e=this.animationNode.getElementsByTagName("sequence")[0].getAttribute("repeatfrom"),g=this.animationNode.getElementsByTagName("gravity"),h=this.animationNode.getElementsByTagName("border"),i=this.animationNode.getElementsByTagName("frame").length+(this.animationNode.getElementsByTagName("frame").length-e)*m;if(j=this.animationStep<this.animationNode.getElementsByTagName("frame").length?this.animationNode.getElementsByTagName("frame")[this.animationStep].textContent:0==e?this.animationNode.getElementsByTagName("frame")[this.animationStep%this.animationNode.getElementsByTagName("frame").length].textContent:this.animationNode.getElementsByTagName("frame")[parseInt(e)+parseInt((this.animationStep-e)%(this.animationNode.getElementsByTagName("frame").length-e))].textContent,this.DOMimg.style.left=-this.imageW*(j%this.tilesX)+"px",this.DOMimg.style.top=-this.imageH*parseInt(j/this.tilesX)+"px",this.dragging||this.infobox)return this.animationStep++,void setTimeout(this._nextESheepStep.bind(this),50);if(this.flipped&&(c=-c,b=-b),0==this.animationStep?this._setPosition(c,f,!1):this._setPosition(parseInt(c)+parseInt((b-c)*this.animationStep/i),parseInt(f)+parseInt((d-f)*this.animationStep/i),!1),this.animationStep++,!(this.animationStep>=i)||(this.animationNode.getElementsByTagName("action")[0]&&"flip"===this.animationNode.getElementsByTagName("action")[0].textContent&&("rotateY(0deg)"==this.DOMdiv.style.transform?(this.DOMdiv.style.transform="rotateY(180deg)",this.flipped=!0):(this.DOMdiv.style.transform="rotateY(0deg)",this.flipped=!1)),this._getNextRandomNode(this.animationNode.getElementsByTagName("sequence")[0]))){var a=!1;if(!(h&&h[0]&&h[0].getElementsByTagName("next")&&(b<0&&this.imageX<0?(this.imageX=0,a=!0):b>0&&this.imageX>this.screenW-this.imageW?(this.imageX=this.screenW-this.imageW,this.DOMdiv.style.left=parseInt(this.imageX)+"px",a=!0):d<0&&this.imageY<0?(this.imageY=0,a=!0):d>0&&this.imageY>this.screenH-this.imageH?(this.imageY=this.screenH-this.imageH,a=!0):d>0?this._checkOverlapping()&&this.imageY>this.imageH&&(this.HTMLelement=this._checkOverlapping(),this.imageY=Math.ceil(this.HTMLelement.getBoundingClientRect().top)-this.imageH,a=!0):this.HTMLelement&&(this._checkOverlapping()||(this.imageY+this.imageH>this.HTMLelement.getBoundingClientRect().top+3||this.imageY+this.imageH<this.HTMLelement.getBoundingClientRect().top-3?this.HTMLelement=null:this.imageX<this.HTMLelement.getBoundingClientRect().left?(this.imageX=parseInt(this.imageX+3),a=!0):(this.imageX=parseInt(this.imageX-3),a=!0),this.DOMdiv.style.left=parseInt(this.imageX)+"px")),a&&!this._getNextRandomNode(h[0]))|| !a&&g&&g[0]&&g[0].getElementsByTagName("next")&&this.imageY<this.screenH-this.imageH-2&&(null==this.HTMLelement?a=!0:this._checkOverlapping()||(a=!0,this.HTMLelement=null),a&&!this._getNextRandomNode(g[0]))))return!a&&(this.imageX< -this.imageW&&b<0||this.imageX>this.screenW&&b>0||this.imageY< -this.imageH&&f<0||this.imageY>this.screenH&&d>0)?(a=!0,void(this.isChild||this._spawnESheep())):void setTimeout(this._nextESheepStep.bind(this),parseInt(k)+parseInt((l-k)*this.animationStep/i))}}}},{key:"_loadPetList",value:function(a){var b=this;fetch("https://adrianotiger.github.io/desktopPet/Pets/pets.json",{credentials:"same-origin",cache:"force-cache"}).then(function(a){return a.json()}).then(function(c){console.log(c),c.pets&&a.addEventListener("mouseup",function(e){e.preventDefault(),e.stopPropagation();var h,d=document.createElement("div");d.setAttribute("style","position:absolute;left:0px;top:20px;width:183px;min-height:100px;background:linear-gradient(to bottom, #8080ff, #3030a1);color:yellow;"),a.parentNode.appendChild(d);var f=function(a){(h=document.createElement("b")).setAttribute("style","cursor:pointer;display:block;"),h.appendChild(document.createTextNode(c.pets[a].folder)),h.addEventListener("click",function(){new eSheep(b.userOptions).Start("https://adrianotiger.github.io/desktopPet/Pets/"+c.pets[a].folder+"/animations.xml"),b.remove()}),d.appendChild(h)};for(var g in c.pets)f(g);d.addEventListener("click",function(b){a.parentNode.removeChild(d)})})})}},]),eSheep}()